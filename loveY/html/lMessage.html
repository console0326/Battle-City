<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1,user-scalable=no"/>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/lMessage.css">
</head>
<body>
<header class="header">
    <div class="leftBox">
        <img src="../img/imgs11.png" alt="">
    </div>
    <div class="reightBox" id="fSon">发送</div>
</header>
<section class="picDiv">
    <form id="form">
        <textarea class="texts" name="message" id="texts"></textarea>
        <input type="hidden" name="image" id="s">
    <div class="tuku" style="display: -webkit-box"></div>
    <div class="adds">
        <input type="file" class="file" name="photo" id="file" multiple accept="image/png, image/jpeg, image/gif, image/jpg">
        <div class="addBox"><img src="../img/imgs12.png" alt=""></div>
    </div>
    </form>
</section>
<script src="../js/app.js"></script>
<script src="../js/jquery-1.8.3.min.js"></script>
<script>
    var userAgent = navigator.userAgent;
    $("#file").change(function () {
        var docObj =$(this)[0];
        var picDiv=$(this).parents(".picDiv");
        var fileList = docObj.files;
        for (var i = 0; i < fileList.length; i++) {
            var picHtml="<div class='imageDiv' > <img id='img" + fileList[i].name + "' /> <div class='cover'><i class='delbtn'>删除</i></div></div>"
            $(".tuku").prepend(picHtml);
            var imgObjPreview = document.getElementById("img"+fileList[i].name);
            if (fileList && fileList[i]) {
                imgObjPreview.style.display = 'block';
                imgObjPreview.style.width = '1.5rem';
                imgObjPreview.style.height = '1.5rem';
                //imgObjPreview.src = docObj.files[0].getAsDataURL();
                if(userAgent.indexOf('MSIE') == -1){//IE以外浏览器
                    imgObjPreview.src = window.URL.createObjectURL(docObj.files[i]); //获取上传图片文件的物理路径
                }else{//IE浏览器
                    if(docObj.value.indexOf(",")!=-1){
                        var srcArr=docObj.value.split(",");
                        imgObjPreview.src = srcArr[i];
                    }else{
                        imgObjPreview.src = docObj.value;
                    }
                }
            }
        }
        // console.log($(this).get(0).files[0]);
        var fl=$(this).get(0).files[0];
        var imgs=document.createElement("img");
        var obj=window.URL.createObjectURL(fl)||window.webkitURL.createObjectURL(fl);
        imgs.src=obj;
        //删除功能
        $(".delbtn").hover(function () {
            var _this=$(this);
            _this.parents(".imageDiv").remove();
        });
    });
    $("#fSon").on("click",function(){
        var tes=$("form").serialize();
        $.ajax({
            type:"post",
            url:"../php/index.php?c=Message&a=sendMessage",
            dataType:"json",
            data:tes,
            success:function(data){
                console.log(data);
                if(data.code=="403"){
                    alert(data.message);
                }else if(data.code=="200"){
                    alert(data.message);
                }
            }
        });
        var data=new FormData($("#form")[0]);
        console.log(data);
        $.ajax({
            url:"../php/server.php",
            type:"post",
            dataType:"json",
            data:data,
            processData:false,
            contentType:false,
            success:function (data){
                console.log(data);
                var i = data.photo.slice(3);
                console.log(i);
                $("#s").val(i);
                var s=$("#form").serialize();
                console.log(s);
                $.ajax({
                    type:"post",
                    url:'../php/index.php?c=message&a=sendMessage',
                    dataType:"json",
                    data:s,
                    success:function(data){
                        console.log(data);
                        if(data.code=="403"){
                            alert(data.message);
                        }else if(data.code=="200"){
                            alert(data.message);
                        }
                    }
                });
            }
        });
    })
</script>
</body>
</html>